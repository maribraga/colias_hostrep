---
title: "Data for all analyses"
format: html
editor: visual
---

```{r}
#| label: packages
#| message: false

library(ape)
library(evolnets)
library(tidyverse)
```

### Processed data

```{r}
tree_full <- read.tree("./data/full_tree_clean.tre")
geo_data_full <- read.csv("./data/Colias_distribution.csv")
host_data_full <- read.csv("./data/Colias_hosts.csv")

Ntip(tree_full)
n_distinct(geo_data_full$species)
n_distinct(host_data_full$species)

```

Drop Zerene. Model violation (constant rate?)

```{r}
tree_colias <- drop.tip(tree_full, "Zerene_cesonia")

plot(tree_colias, cex = 0.5)
axisPhylo()
```

### Data for historical biogeography analysis

Get the intersect between the tree and the distribution data

```{r}
spp_geo <- intersect(tree_colias$tip.label, geo_data_full$species)

# one species missing distribution data
setdiff(tree_colias$tip.label, geo_data_full$species)

setdiff(geo_data_full$species, tree_colias$tip.label)
```

Prune tree and distribution data to include only species in both

```{r}
tree_geo <- drop.tip(tree_full, setdiff(tree_full$tip.label, spp_geo))
tree_geo
write.tree(tree_geo, "./biogeography/data/tree_colias_geo.tre")

geo_data <- filter(geo_data_full, species %in% spp_geo)
```

Make nexus data file

```{r}
geo_data_matrix <- geo_data %>% 
  mutate(Neotropics = case_when(range == "Neotropical" ~ 1, TRUE ~ 0),
         Nearctic = case_when(range %in% c("Nearctic", "Nam Asia", "Arctic") ~ 1, TRUE ~ 0),
         PalearcticEast = case_when(range %in% c("Palearctic East", "East Asia", "Palearctic low",
                                                 "Nam Asia","Palearctic", "Arctic") ~ 1, TRUE ~ 0),
         QTP = case_when(range %in% c("QTP", "East Asia", "West QTP", "Palearctic") ~ 1, TRUE ~ 0),
         SEAsia = case_when(range %in% c("East Asia") ~ 1, TRUE ~ 0),
         PalearcticWest = case_when(range %in% c("Palearctic West", "West QTP", "Palearctic low",
                                                 "Palearctic", "Arctic") ~ 1, TRUE ~ 0),
         Africa = case_when(range == "African" ~ 1, TRUE ~ 0)) %>% 
  select(-range) %>% 
  column_to_rownames("species") %>% 
  as.matrix()

# reorder rows and columns - regions according to order in features
geo_data_matrix <- geo_data_matrix[tree_geo$tip.label,]
colnames(geo_data_matrix) <- c("NT","NA","EP","PTP","SA","WP","AF")
geo_data_matrix <- geo_data_matrix[,c("SA","EP","WP","NA","PTP","AF","NT")] 

write.nexus.data(geo_data_matrix, "./biogeography/data/colias.range.nex", format = "standard")
```

Create file with color palette for plots

```{r}
levels = c("Neotropical",
           "Nearctic",
           "N_American-Asian",
           "Arctic",
           "Palearctic_east",
           "East_Asian",
           "QTP",
           "West_QTP",
           "Palearctic",
           "Palearctic_notQTP",
           "Palearctic_west",
           "African")

ranges <- c("A","B","BC","BCF","C","CDE","E","EF","CEF","CF","F","G")

palette <- c("#FF8C01",
             "#DA3541",
             "#AA74A1",
             "#6E4672",
             "#00A2FF",
             "#00D164",
             "#F8C700",
             "#097C65",
             "#009F52",
             "#347FD5",
             "#013459",
             "#EF9FBA")

colors_df <- tibble(names = levels, ranges = ranges, color = palette)

```

### Data for host repertoire evolution analysis

```{r}
spp_host <- intersect(tree_full$tip.label, host_data_full$species)

# tips without host use data
setdiff(tree_full$tip.label, host_data_full$species)

# species with knows hosts but not in the tree
setdiff(host_data_full$species, tree_full$tip.label)
```

Prune tree and host data to include only species in both

```{r}
tree_host <- drop.tip(tree_full, setdiff(tree_full$tip.label, spp_host))
tree_host

host_data <- filter(host_data_full, species %in% spp_host)
```

#### Make interaction matrix from edge list

```{r}

# the interaction matrix needs to be in the correct format for RevBayes
# edge list to matrix
matrix <- host_data %>% 
  select(-host_family) %>% 
  mutate(values = 2) %>% 
  pivot_wider(names_from = host_genus, values_from = values) %>% 
  column_to_rownames("species") %>% 
  as.matrix()

# check that all host are in the matrix
dim(matrix)[2] == n_distinct(host_data$host_genus)

# replace NAs with 0
matrix[is.na(matrix)] <- 0

# order rows by tree
matrix_phylo <- as.matrix(matrix)[tree_host$tip.label,]

# host tree


```

**Write out data for RevBayes**

```{r}
#| eval: false

write.tree(tree_host, "./host_repertoire/data/tree_colias.tre")

write.csv(matrix_phylo, "./host_repertoire/data/interaction_matrix.csv")
write.nexus.data(matrix_phylo, "./host_repertoire/data/interaction_matrix.nex", format = "standard")
# then, fix header to match RevBayes style
```
